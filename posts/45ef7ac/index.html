<!DOCTYPE html><html lang="zh_CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0"><link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222"><link rel="stylesheet" href="/css/main.css?v=7.4.0"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"7.4.0",exturl:!1,sidebar:{position:"right",display:"hide",offset:12,onmobile:!0},copycode:{enable:!0,show_result:!0,style:"flat"},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!0,color:"#999",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:-1,unescape:!0,preload:!0},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},translation:{copy_button:"Copy",copy_success:"Copied",copy_failure:"Copy failed"},sidebarPadding:40}</script><meta name="description" content="主要记录了由普通PHP开发者初步接触laravelS是所遇到的一些小坑"><meta name="keywords" content="PHP,异步,laravel,LaravelS,Lumen,swoole"><meta property="og:type" content="article"><meta property="og:title" content="LaravelS开发记录"><meta property="og:url" content="https://hexo.lilis.xin/posts/45ef7ac/index.html"><meta property="og:site_name" content="小叽の博客"><meta property="og:description" content="主要记录了由普通PHP开发者初步接触laravelS是所遇到的一些小坑"><meta property="og:locale" content="zh_CN"><meta property="og:updated_time" content="2019-09-13T07:34:45.987Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="LaravelS开发记录"><meta name="twitter:description" content="主要记录了由普通PHP开发者初步接触laravelS是所遇到的一些小坑"><link rel="alternate" href="/atom.xml" title="小叽の博客" type="application/atom+xml"><link rel="canonical" href="https://hexo.lilis.xin/posts/45ef7ac/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,isPage:!1,isArchive:!1}</script><title>LaravelS开发记录 | 小叽の博客</title><meta name="generator" content="Hexo 3.9.0"><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh_CN"><div class="container use-motion"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">小叽の博客</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"><button aria-label="Toggle navigation bar"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Searching..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a class="book-mark-link book-mark-link-fixed" href="#"></a><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article itemscope itemtype="http://schema.org/Article"><div class="post-block post"><link itemprop="mainEntityOfPage" href="https://hexo.lilis.xin/posts/45ef7ac/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="小叽"><meta itemprop="description" content=""><meta itemprop="image" content="/images/head.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="小叽の博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">LaravelS开发记录</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-10-29 16:35:19" itemprop="dateCreated datePublished" datetime="2018-10-29T16:35:19+08:00">2018-10-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2019-09-13 15:34:45" itemprop="dateModified" datetime="2019-09-13T15:34:45+08:00">2019-09-13</time></span></div></header><div class="post-body" itemprop="articleBody"><p>主要记录了由普通PHP开发者初步接触laravelS是所遇到的一些小坑<br><a id="more"></a></p><h3 id="LaravelS介绍"><a href="#LaravelS介绍" class="headerlink" title="LaravelS介绍"></a>LaravelS介绍</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> _                               _  _____</span><br><span class="line">| |                             | |/ ____|</span><br><span class="line">| |     __ _ _ __ __ ___   _____| | (___</span><br><span class="line">| |    / _` | &apos;__/ _` \ \ / / _ \ |\___ \</span><br><span class="line">| |___| (_| | | | (_| |\ V /  __/ |____) |</span><br><span class="line">|______\__,_|_|  \__,_| \_/ \___|_|_____/</span><br></pre></td></tr></table></figure><p>LaravelS是一个能够使普通的laravel项目尽快的享受上swoole的优势的laravel插件<br>官方描述:<br>🚀LaravelS是一个胶水项目，用于快速集成Swoole到Laravel或Lumen，然后赋予它们更好的性能、更多可能性。</p><p>GitHub地址:<br></p><div style="text-align:center"><div class="github-card" data-user="hhxsv5" data-repo="laravel-s" data-height="200px" data-width="100%" data-theme="default" data-target="blank" data-client-id data-client-secret></div></div><script src="/github-card-lib/githubcard.js"></script><br>文档地址:<br><a href="https://github.com/hhxsv5/laravel-s/blob/master/README-CN.md" title="laravel-s/README-CN.md" target="_blank" rel="noopener">laravel-s/README-CN.md</a><br>Laravel-China地址:<br><a href="https://laravel-china.org/articles/8050/laravels-speed-up-laravellumen-through-swoole" title="LaravelS - 基于 Swoole 加速 Laravel/Lumen - 带你飞 🚀" target="_blank" rel="noopener">LaravelS - 基于 Swoole 加速 Laravel/Lumen - 带你飞 🚀</a><p></p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="安装要求"><a href="#安装要求" class="headerlink" title="安装要求"></a>安装要求</h4><table><thead><tr><th>依赖</th><th>说明</th></tr></thead><tbody><tr><td>PHP</td><td>&gt;= 5.5.9 推荐PHP7+</td></tr><tr><td>Swoole</td><td>&gt;= 1.7.19 从2.0.12开始不再支持PHP5 推荐4.2.3+</td></tr><tr><td>Laravel/Lumen</td><td>&gt;= 5.1 推荐5.6+</td></tr></tbody></table><h4 id="安装swoole"><a href="#安装swoole" class="headerlink" title="安装swoole"></a>安装swoole</h4><p>详细请参考 <a href="https://hexo.lilis.xin/2018/07/26/install-swoole/" title="swoole安装">swoole安装</a></p><h4 id="安装laravel"><a href="#安装laravel" class="headerlink" title="安装laravel"></a>安装laravel</h4><p>可以通过composer直接安装,或者安装安装器或者直接从GitHub拷贝源代码来安装</p><h4 id="安装laravelS"><a href="#安装laravelS" class="headerlink" title="安装laravelS"></a>安装laravelS</h4><ol><li><p>通过Composer安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">composer require "hhxsv5/laravel-s:~3.0" -vvv</span><br><span class="line"><span class="meta">#</span><span class="bash"> 确保你的composer.lock文件是在版本控制中</span></span><br></pre></td></tr></table></figure></li><li><p>注册<code>Service Provider</code></p><ul><li><p>Laravel: 修改文件<code>config/app.php</code>，Laravel 5.5+支持包自动发现，你应该跳过这步</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'providers'</span> =&gt; [</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    Hhxsv5\LaravelS\Illuminate\LaravelSServiceProvider::class,</span><br><span class="line">],</span><br></pre></td></tr></table></figure></li><li><p>Lumen: 修改文件<code>bootstrap/app.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$app-&gt;register(Hhxsv5\LaravelS\Illuminate\LaravelSServiceProvider::class);</span><br></pre></td></tr></table></figure></li></ul></li><li><p>发布配置文件.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan laravels publish</span><br></pre></td></tr></table></figure></li></ol><p>如果你用的是<code>lumen</code>,不需要加载<code>config/laravels.php</code><br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个可有可无</span></span><br><span class="line">$app-&gt;configure(<span class="string">'laravels'</span>);</span><br></pre></td></tr></table></figure><p></p><ol start="4"><li>修改配置<code>config/laravels.php</code><br>请参考<code>laravelS配置项</code></li></ol><h4 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan laravels &#123;start|stop|restart|reload|publish&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>start</td><td>启动<code>LaravelS</code>。选项<code>-d</code>或<code>--daemonize</code>以守护进程的方式运行，此选项将覆盖<code>laravels.php</code>中<code>swoole.daemonize</code>设置</td></tr><tr><td>stop</td><td>停止<code>LaravelS</code></td></tr><tr><td>restart</td><td>重启<code>LaravelS</code>，支持选项<code>-d</code>或<code>--daemonize</code></td></tr><tr><td>reload</td><td>平滑重启所有<code>worker</code>进程，这些<code>worker</code>进程内包含你的业务代码和框架(<code>Laravel/Lumen</code>)代码，不会重启<code>master/manger</code>进程</td></tr><tr><td>publish</td><td>发布配置文件到你的项目中<code>config/laravels.php</code></td></tr></tbody></table><p>ps:展示已经启动的项目:<br><code>ps -ef|grep laravels</code></p><h4 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">gzip on;</span><br><span class="line">gzip_min_length 1024;</span><br><span class="line">gzip_comp_level 2;</span><br><span class="line">gzip_types text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml application/x-httpd-php image/jpeg image/gif image/png font/ttf font/otf image/svg+xml;</span><br><span class="line">gzip_vary on;</span><br><span class="line">gzip_disable "msie6";</span><br><span class="line">upstream laravels &#123;</span><br><span class="line">    # By IP:Port</span><br><span class="line">    server 127.0.0.1:9100 weight=5 max_fails=3 fail_timeout=30s; #这里配置的是laravelS监听的接口参数</span><br><span class="line">    # By UnixSocket Stream file</span><br><span class="line">    #server unix:/xxxpath/laravel-s-test/storage/laravels.sock weight=5 max_fails=3 fail_timeout=30s;</span><br><span class="line">    #server 192.168.1.1:5200 weight=3 max_fails=3 fail_timeout=30s;</span><br><span class="line">    #server 192.168.1.2:5200 backup;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name laravels.com;</span><br><span class="line"><span class="meta">	#</span><span class="bash">为了给nginx定位静态资源</span></span><br><span class="line">	root /xxxpath/laravel-s-test/public;</span><br><span class="line"><span class="meta">	#</span><span class="bash"> Nginx处理静态资源(建议开启gzip)，LaravelS处理动态资源。</span></span><br><span class="line">	location / &#123;</span><br><span class="line">		try_files $uri @laravels;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	location @laravels &#123;</span><br><span class="line">        proxy_connect_timeout 60s;</span><br><span class="line">        proxy_send_timeout 60s;</span><br><span class="line">        proxy_read_timeout 120s;</span><br><span class="line">        proxy_set_header Connection "keep-alive";</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Real-PORT $remote_port;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header Host $http_host;</span><br><span class="line">        proxy_set_header Scheme $scheme;</span><br><span class="line">        proxy_set_header Server-Protocol $server_protocol;</span><br><span class="line">        proxy_set_header Server-Name $server_name;</span><br><span class="line">        proxy_set_header Server-Addr $server_addr;</span><br><span class="line">        proxy_set_header Server-Port $server_port;</span><br><span class="line">        proxy_pass http://laravels;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="配置Apache"><a href="#配置Apache" class="headerlink" title="配置Apache"></a>配置Apache</h4><p>ps:我用的是nginx,没有实际配置过,就直接把官方文档里的拿过来了<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">LoadModule proxy_module /yyypath/modules/mod_deflate.so</span><br><span class="line"><span class="tag">&lt;<span class="name">IfModule</span> <span class="attr">deflate_module</span>&gt;</span></span><br><span class="line">    SetOutputFilter DEFLATE</span><br><span class="line">    DeflateCompressionLevel 2</span><br><span class="line">    AddOutputFilterByType DEFLATE text/html text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml application/x-httpd-php image/jpeg image/gif image/png font/ttf font/otf image/svg+xml</span><br><span class="line"><span class="tag">&lt;/<span class="name">IfModule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> *<span class="attr">:80</span>&gt;</span></span><br><span class="line">    # 别忘了绑Host哟</span><br><span class="line">    ServerName www.laravels.com</span><br><span class="line">    ServerAdmin hhxsv5@sina.com</span><br><span class="line"></span><br><span class="line">    DocumentRoot /xxxpath/laravel-s-test/public;</span><br><span class="line">    DirectoryIndex index.html index.htm</span><br><span class="line">    <span class="tag">&lt;<span class="name">Directory</span> "/"&gt;</span></span><br><span class="line">        AllowOverride None</span><br><span class="line">        Require all granted</span><br><span class="line">    <span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    LoadModule proxy_module /yyypath/modules/mod_proxy.so</span><br><span class="line">    LoadModule proxy_module /yyypath/modules/mod_proxy_balancer.so</span><br><span class="line">    LoadModule proxy_module /yyypath/modules/mod_lbmethod_byrequests.so.so</span><br><span class="line">    LoadModule proxy_module /yyypath/modules/mod_proxy_http.so.so</span><br><span class="line">    LoadModule proxy_module /yyypath/modules/mod_slotmem_shm.so</span><br><span class="line">    LoadModule proxy_module /yyypath/modules/mod_rewrite.so</span><br><span class="line"></span><br><span class="line">    ProxyRequests Off</span><br><span class="line">    ProxyPreserveHost On</span><br><span class="line">    <span class="tag">&lt;<span class="name">Proxy</span> <span class="attr">balancer:</span>//<span class="attr">laravels</span>&gt;</span></span><br><span class="line">        BalancerMember http://192.168.1.1:8011 loadfactor=7</span><br><span class="line">        #BalancerMember http://192.168.1.2:8011 loadfactor=3</span><br><span class="line">        #BalancerMember http://192.168.1.3:8011 loadfactor=1 status=+H</span><br><span class="line">        ProxySet lbmethod=byrequests</span><br><span class="line">    <span class="tag">&lt;/<span class="name">Proxy</span>&gt;</span></span><br><span class="line">    #ProxyPass / balancer://laravels/</span><br><span class="line">    #ProxyPassReverse / balancer://laravels/</span><br><span class="line"></span><br><span class="line">    # Apache处理静态资源，LaravelS处理动态资源。</span><br><span class="line">    RewriteEngine On</span><br><span class="line">    RewriteCond %&#123;DOCUMENT_ROOT&#125;%&#123;REQUEST_FILENAME&#125; !-d</span><br><span class="line">    RewriteCond %&#123;DOCUMENT_ROOT&#125;%&#123;REQUEST_FILENAME&#125; !-f</span><br><span class="line">    RewriteRule ^/(.*)$ balancer://laravels/%&#123;REQUEST_URI&#125; [P,L]</span><br><span class="line"></span><br><span class="line">    ErrorLog $&#123;APACHE_LOG_DIR&#125;/www.laravels.com.error.log</span><br><span class="line">    CustomLog $&#123;APACHE_LOG_DIR&#125;/www.laravels.com.access.log combined</span><br><span class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><h4 id="自定义的异步任务"><a href="#自定义的异步任务" class="headerlink" title="自定义的异步任务"></a>自定义的异步任务</h4><p>此特性依赖<code>Swoole</code>的<code>AsyncTask</code>，必须先设置<code>config/laravels.php</code>的<code>swoole.task_worker_num</code>。<br>异步事件的处理能力受<code>Task</code>进程数影响，需合理设置<code>task_worker_num</code>。<br>任务结构<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Task</span>\<span class="title">Message</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Traits</span>\<span class="title">Push</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Hhxsv5</span>\<span class="title">LaravelS</span>\<span class="title">Swoole</span>\<span class="title">Task</span>\<span class="title">Task</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reply</span> <span class="keyword">extends</span> <span class="title">Task</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = $data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">		<span class="comment">//Do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ps: 任务里没有依赖注入这种便捷的东西<br>投递任务<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实例化$action并通过deliver投递</span></span><br><span class="line"><span class="comment">//此操作是异步的，投递后立即返回</span></span><br><span class="line"><span class="comment">//由Task进程继续处理$action中的handle逻辑</span></span><br><span class="line">$task = <span class="keyword">new</span> \App\Task\Message\Reply($dat);</span><br><span class="line"><span class="comment">// $task-&gt;delay(3);// 延迟3秒投放任务</span></span><br><span class="line">\Hhxsv5\LaravelS\Swoole\Task\Task::deliver($task);</span><br></pre></td></tr></table></figure><p></p><h4 id="laravelS配置项"><a href="#laravelS配置项" class="headerlink" title="laravelS配置项"></a>laravelS配置项</h4><ul><li><p><code>listen_ip</code>：<code>string</code> 监听的IP，监听本机<code>127.0.0.1</code>(IPv4) <code>::1</code>(IPv6)，监听所有地址 <code>0.0.0.0</code>(IPv4) ::(IPv6)， 默认<code>127.0.0.1</code>。</p></li><li><p><code>listen_port</code>：<code>int</code> 监听的端口，如果端口小于1024则需要root权限，<code>default 5200</code>。</p></li><li><p><code>socket_type</code>：默认<code>SWOOLE_SOCK_TCP</code>。通常情况下，无需关心这个配置。若需Nginx代理至<code>UnixSocket Stream</code>文件，则需修改为<code>SWOOLE_SOCK_UNIX_STREAM</code>，此时<code>listen_ip</code>则是<code>UnixSocket Stream</code>文件的路径。</p></li><li><p><code>enable_gzip</code>：bool 当通过LaravelS响应数据时，是否启用gzip压缩响应的内容，依赖库<code>zlib</code>，通过命令<code>php --ri swoole|grep zlib</code>检查<code>gzip</code>是否可用。如果开启则会自动加上头部<code>Content-Encoding</code>，默认<code>false</code>。如果存在代理服务器（例如Nginx），建议代理服务器开启<code>gzip</code>，<code>LaravelS</code>关闭gzip，避免重复<code>gzip</code>压缩。</p></li><li><p><code>server</code>：<code>string</code> 当通过<code>LaravelS</code>响应数据时，设置<code>HTTP</code>头部<code>Server</code>的值，若为空则不设置，<code>default LaravelS</code>。</p></li><li><p><code>handle_static</code>：<code>bool</code> 是否开启<code>LaravelS</code>处理静态资源(要求 <code>Swoole &gt;= 1.7.21</code>，若<code>Swoole &gt;= 1.9.17</code>则由Swoole自己处理)，默认<code>false</code>，建议<code>Nginx</code>处理静态资源，<code>LaravelS</code>仅处理动态资源。静态资源的默认路径为<code>base_path(&#39;public&#39;)</code>，可通过修改<code>swoole.document_root</code>变更。</p></li><li><p><code>laravel_base_path</code>：<code>string</code> <code>Laravel/Lumen</code>的基础路径，默认<code>base_path()</code>，可用于配置符号链接。</p></li><li><p><code>inotify_reload.enable</code>：<code>bool</code> 是否开启<code>Inotify Reload</code>，用于当修改代码后实时<code>Reload</code>所有<code>worker</code>进程，依赖库<code>inotify</code>，通过命令<code>php --ri inotify</code>检查是否可用，默认<code>false</code>，建议仅开发环境开启，修改监听数上限。</p></li><li><p><code>inotify_reload.watch_path</code>：<code>string</code> <code>Inotify</code> 监控的文件路径，默认有<code>base_path()</code>。</p></li><li><p><code>inotify_reload.file_types</code>：<code>array</code> <code>Inotify</code> 监控的文件类型，默认有<code>.php</code>。</p></li><li><p><code>inotify_reload.log</code>：<code>bool</code> 是否输出<code>Reload</code>的日志，默认<code>true</code>。</p></li><li><p><code>websocket.enable</code>：<code>bool</code> 是否启用<code>WebSocket</code>服务器。启用后<code>WebSocket</code>服务器监听的<code>IP</code>和端口与<code>Http</code>服务器相同，默认<code>false</code>。</p></li><li><p><code>websocket.handler</code>：<code>string</code> <code>WebSocket</code>逻辑处理的类名，需实现接口<code>WebSocketHandlerInterface</code>，参考示例。</p></li><li><p><code>sockets</code>：<code>array</code> 配置<code>TCP/UDP</code>套接字列表，参考示例。</p></li><li><p><code>processes</code>：<code>array</code> 配置自定义进程列表，参考示例。</p></li><li><p><code>events</code>：<code>array</code> 自定义的异步事件和监听的绑定列表，参考示例。</p></li><li><p><code>swoole_tables</code>：<code>array</code> 定义的<code>swoole_table</code>列表，参考示例。</p></li><li><p><code>register_providers</code>：<code>array</code> 每次请求需要重新注册的<code>Service Provider</code>列表，若存在<code>boot()</code>方法，会自动执行。一般用于清理注册了单例的<code>ServiceProvider</code>。</p></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="string">'register_providers'</span> =&gt; [</span><br><span class="line">    <span class="comment">//例如：重新注册jwt的ServiceProvider</span></span><br><span class="line">    \Tymon\JWTAuth\Providers\LaravelServiceProvider::class,</span><br><span class="line">],</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure><ul><li>swoole：<code>array</code> <code>Swoole</code>的原始配置项，请参考<a href="https://wiki.swoole.com/wiki/page/274.html" title="Swoole配置项" target="_blank" rel="noopener">Swoole配置项</a>。</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/PHP/" rel="tag"># PHP</a> <a href="/tags/异步/" rel="tag"># 异步</a> <a href="/tags/laravel/" rel="tag"># laravel</a> <a href="/tags/LaravelS/" rel="tag"># LaravelS</a> <a href="/tags/Lumen/" rel="tag"># Lumen</a> <a href="/tags/swoole/" rel="tag"># swoole</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/d90db6f7/" rel="next" title="php在linux下call to undefined function imagettftext()"><i class="fa fa-chevron-left"></i> php在linux下call to undefined function imagettftext()</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/posts/5cd7067a/" rel="prev" title="测试Emoji表情">测试Emoji表情 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="gitalk-container"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#LaravelS介绍"><span class="nav-number">1.</span> <span class="nav-text">LaravelS介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">2.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装要求"><span class="nav-number">2.1.</span> <span class="nav-text">安装要求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装swoole"><span class="nav-number">2.2.</span> <span class="nav-text">安装swoole</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装laravel"><span class="nav-number">2.3.</span> <span class="nav-text">安装laravel</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装laravelS"><span class="nav-number">2.4.</span> <span class="nav-text">安装laravelS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#运行"><span class="nav-number">2.5.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置nginx"><span class="nav-number">2.6.</span> <span class="nav-text">配置nginx</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置Apache"><span class="nav-number">2.7.</span> <span class="nav-text">配置Apache</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义的异步任务"><span class="nav-number">2.8.</span> <span class="nav-text">自定义的异步任务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#laravelS配置项"><span class="nav-number">2.9.</span> <span class="nav-text">laravelS配置项</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/head.png" alt="小叽"><p class="site-author-name" itemprop="name">小叽</p><div class="site-description" itemprop="description"></div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">48</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">49</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i>RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/l552121229" title="GitHub &rarr; https://github.com/l552121229" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:552121229l@gmail.com" title="E-Mail &rarr; mailto:552121229l@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://blog.caoxl.com/" title="https://blog.caoxl.com/" rel="noopener" target="_blank">Keep It Simple And Stupid</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">小叽</span></div><div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div><span class="post-meta-divider">|</span><div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.4.0</div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js?v=3.1.0"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script><script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script><script src="/js/schemes/muse.js?v=7.4.0"></script><script src="/js/next-boot.js?v=7.4.0"></script><script src="/js/bookmark.js?v=7.4.0"></script><script>var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[pjax], script#page-configurations, #pjax script').forEach(element => {
    var id = element.id || '';
    var src = element.src || '';
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (id !=='') {
      script.id = element.id;
    }
    if (src !== '') {
      script.src = src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});</script><script src="/js/local-search.js?v=7.4.0"></script><div id="pjax"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css"><script>NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '03bad61b5e430dca9413',
      clientSecret: 'bd73e83ab1d1764598a44f6324c7842d162372c6',
      repo: 'l552121229.github.io.comments',
      owner: 'l552121229',
      admin: ['l552121229'],
      id: '772e5841676c06628198982527adfcd0',
        language: window.navigator.language || window.navigator.userLanguage,
      
      distractionFreeMode: 'true'
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);</script></div></body></html>